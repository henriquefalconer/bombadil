# Implementation Plan

## Previously Completed

- CSP selective stripping for documents (hash/nonce removal in `script-src`/`script-src-elem`, resource-type-aware header filtering)
- HSTS: stopped unconditional stripping (`strict-transport-security` removed from denylist)
- Added `digest` header to denylist (instrumentation invalidates body hash)
- HTML fixture cleanup for fork-added tests (matched upstream structure)

## Remaining Items

### 1. `default-src` hash fallback not sanitized (HIGH)

- **Problem**: `sanitize_csp()` only strips hashes/nonces from `script-src` and `script-src-elem`. When neither directive is present, browsers fall back to `default-src` for script-loading decisions, so hashes in `default-src` are invalidated by instrumentation but never stripped.
- **Fix**: After processing all directives, check if neither `script-src` nor `script-src-elem` was found. If so, apply the same hash/nonce stripping to `default-src` (if present).
- **Tests**:
  - Unit: `sanitize_csp("default-src 'sha256-abc' 'self'")` -> strips hash, returns `Some("default-src 'self'")`
  - Unit: `sanitize_csp("default-src 'sha256-abc' 'self'; script-src 'unsafe-inline'")` -> does NOT touch `default-src` (because `script-src` is present)
  - Integration: HTML fixture with CSP `default-src 'sha256-...' 'unsafe-inline'` (no `script-src`), verify inline script runs after instrumentation

### 2. `strict-dynamic` left without trust anchor after nonce removal (HIGH)

- **Problem**: Stripping nonces from `script-src 'nonce-abc' 'strict-dynamic'` produces `script-src 'strict-dynamic'`, which has no trust anchor and blocks all scripts.
- **Fix**: After filtering hashes/nonces from a directive, also remove `'strict-dynamic'` if no hash or nonce remains. `'strict-dynamic'` is semantically meaningless without a trust anchor.
- **Tests**:
  - Unit: `sanitize_csp("script-src 'nonce-abc' 'strict-dynamic'")` -> strips both nonce and strict-dynamic, empty directive omitted
  - Unit: `sanitize_csp("script-src 'nonce-abc' 'strict-dynamic' 'self'")` -> strips nonce and strict-dynamic, keeps `'self'`
  - Integration: HTML fixture with CSP `script-src 'nonce-abc' 'strict-dynamic'`, verify inline script loads after instrumentation

### 3. CSP violation reports generated by instrumentation (MEDIUM)

- **Problem**: `report-uri` and `report-to` directives are preserved, causing false-positive violation reports sent to the application's reporting endpoint.
- **Fix**: Strip `report-uri` and `report-to` directives in `sanitize_csp()`.
- **Tests**:
  - Unit: `sanitize_csp("script-src 'sha256-abc' 'self'; report-uri /csp-report")` -> strips `report-uri`, returns `Some("script-src 'self'")`
  - Unit: `sanitize_csp("script-src 'self'; report-to csp-group")` -> strips `report-to`, returns `Some("script-src 'self'")`
  - Unit: `sanitize_csp("default-src 'self'; report-uri /r; report-to g")` -> strips both report directives
  - Integration: Not strictly needed (report-uri/report-to stripping is purely a sanitize_csp concern, fully testable at unit level). The existing CSP integration tests already validate the overall sanitization pipeline.

### 4. Resource type wildcard in CSP match (LOW)

- **Problem**: The `match resource_type` arm uses `_ =>` instead of explicitly matching `network::ResourceType::Document =>`, masking potential bugs if new resource types are intercepted in the future.
- **Fix**: Replace `_ =>` with `network::ResourceType::Document =>` and add a `_ => bail!(...)` arm.
- **Tests**: None needed -- existing integration tests cover both Script and Document resource types.
