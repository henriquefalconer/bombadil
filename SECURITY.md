# Open Issues in Response Header Handling

## 1. `default-src` hash fallback not sanitized

`sanitize_csp()` only processes `script-src` and `script-src-elem` directives. When neither is present, browsers fall back to `default-src` for script-loading decisions. If `default-src` contains hash values, those hashes are invalidated by instrumentation but not stripped.

**Effect**: Sites using `default-src 'sha256-...' 'self'` without an explicit `script-src` will have inline scripts blocked in Document responses after instrumentation.

**Fix**: When `sanitize_csp` encounters a `default-src` directive and the CSP has no `script-src` or `script-src-elem`, strip hash/nonce values from `default-src` using the same logic applied to `script-src`.

## 2. `strict-dynamic` left without a trust anchor after nonce removal

Stripping `'nonce-...'` from `script-src 'nonce-abc' 'strict-dynamic'` produces `script-src 'strict-dynamic'`. Since `'strict-dynamic'` makes the browser ignore source expressions and only trust scripts loaded by nonce-bearing or hash-bearing scripts, removing the nonce leaves no trust anchor. The result is an unpredictable script-loading model.

**Effect**: Sites using CSP Level 3 `'strict-dynamic'` with nonces will have some scripts blocked and others allowed in ways that don't match production behavior.

**Fix**: When all nonces and hashes are removed from a `script-src` that contains `'strict-dynamic'`, also remove `'strict-dynamic'` (it has no meaning without a trust root). Alternatively, remove the entire directive so the browser falls back to `default-src`.

## 3. CSP violation reports generated by instrumentation changes

`report-uri` and `report-to` directives are preserved in sanitized CSP headers. When instrumentation changes cause scripts to violate the (modified) policy, the browser sends false-positive violation reports to the application's reporting endpoint. This is especially problematic for `content-security-policy-report-only`, where stripping nonces generates a report for every script load.

**Effect**: Application CSP monitoring dashboards and alerting receive noise from instrumentation-caused violations.

**Fix option A**: Strip `report-uri` and `report-to` directives from CSP headers during sanitization.
**Fix option B**: Leave the enforcing header alone but strip nonces only from the enforcing CSP, not from `content-security-policy-report-only`. (This avoids reports but allows enforcing behavior to change â€” less clean.)

## 4. Resource type wildcard in CSP handling

The `match resource_type` block uses `_ =>` for non-Script CSP handling. Only `Script` and `Document` are registered for interception today, so `_` effectively means `Document`. If a future change adds another resource type, CSP sanitization designed for Documents would silently apply to it.

**Effect**: No current bug, but violates the codebase's established pattern of explicit matching and `bail!` on unexpected resource types.

**Fix**: Replace `_ =>` with `network::ResourceType::Document =>` and add a `_ =>` arm that passes the header through unchanged (or panics, matching the existing `bail!` pattern).
